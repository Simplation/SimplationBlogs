## Gradle Catalog

### å¼•è¨€
éšç€é¡¹ç›®çš„ä¸æ–­è¿­ä»£å’Œå‡çº§ï¼Œä¾èµ–çš„ç‰ˆæœ¬ä¼šé€æ¸å˜å¤§ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ä¾èµ–åº“ç®¡ç†å°±æ˜¾å¾—éå¸¸æœ‰å¿…è¦ã€‚
å·²æœ‰çš„ç»Ÿä¸€ä¾èµ–åº“ç®¡ç†çš„æ–¹å¼ï¼š

- ä½¿ç”¨å¾ªç¯ä¼˜åŒ– `Gradle` ä¾èµ–ç®¡ç†
- ä½¿ç”¨ `buildSrc` ç®¡ç† `Gradle` ä¾èµ–
- ä½¿ç”¨ `includeBuild` ç»Ÿä¸€é…ç½®ä¾èµ–ç‰ˆæœ¬

å·²æœ‰çš„æ–¹å¼æ”¯æŒåœ¨ä¸åŒ `Module` ä¸­å…±äº«ï¼Œå¦‚æœéœ€è¦é¡¹ç›®é—´è¿›è¡Œå…±äº«ï¼Œå‘å¸ƒåˆ°è¿œç«¯å³å¯å®ç°å…±äº«çš„åŠŸèƒ½ï¼ŒåŸºæœ¬ä¸Šå®ç°ç›¸åº”çš„åŠŸèƒ½ã€‚è¿™äº›éƒ½ä¸æ˜¯é‡ç‚¹ï¼Œ
ä¸»è¦æ˜¯è¯´ä¸€ä¸‹ `Gradle 7.0` ç‰ˆæœ¬æ¨å‡ºçš„æ–°ç‰¹æ€§ï¼Œä½¿ç”¨ Catalog è¿›è¡Œç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬çš„ç®¡ç†ï¼Œå…·å¤‡æ–°ç‰¹æ€§ï¼š

- å¯¹æ‰€æœ‰ module å¯è§ï¼Œå¯ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ module çš„ä¾èµ–
- æ”¯æŒå£°æ˜ä¾èµ– bundles,å³æ€»æ˜¯ä¸€èµ·ä½¿ç”¨çš„ä¾èµ–å¯ä»¥ç»„åˆåœ¨ä¸€èµ·
- æ”¯æŒç‰ˆæœ¬å·ä¸ä¾èµ–ååˆ†ç¦»ï¼Œå¯ä»¥åœ¨å¤šä¸ªä¾èµ–é—´å…±äº«ç‰ˆæœ¬å·
- æ”¯æŒåœ¨å•ç‹¬çš„ libs.versions.toml æ–‡ä»¶ä¸­é…ç½®ä¾èµ–
- æ”¯æŒåœ¨é¡¹ç›®é—´å…±äº«ä¾èµ–

### ä½¿ç”¨ Version Catalog

- å¯ç”¨

  `Catalog` å½“å‰è¿˜æ˜¯é¢„è§ˆåŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥å¯ç”¨

  ```groovy
  enableFeaturePreview("VERSION_CATALOGS")
  ```

- é…ç½®

  Version Catalog å…¶å®å°±æ˜¯ä¸€ä¸ªç‰ˆæœ¬ç›®å½•ï¼Œä»ç‰ˆæœ¬ç›®å½•ä¸­é€‰å‡ºéœ€è¦çš„ä¾èµ–ï¼Œä½¿ç”¨ä¸‹é¢çš„æ–¹å¼è¿›è¡Œé…ç½®ã€‚

  ```groovy
  dependencies {
  	implementation(libs.retrofit)
  	implementation(libs.groovy.core)
  }
  ```

- Version Catalog ä¼˜ç‚¹

  - å¯¹äºæ¯ä¸ª catalogï¼Œ`Gradle` éƒ½ä¼šç”Ÿæˆç±»å‹å®‰å…¨çš„è®¿é—®å™¨ï¼Œä»¥ä¾¿ä½ åœ¨ `IDE` ä¸­å¯ä»¥è‡ªåŠ¨è¡¥å…¨.(æ³¨:ç›®å‰åœ¨ `build.gradle` ä¸­è¿˜ä¸èƒ½è‡ªåŠ¨è¡¥å…¨ï¼Œå¯èƒ½æ˜¯æŒ‡ `kts` æˆ–è€…å¼€å‘ä¸­ï¼Ÿ)
  - å£°æ˜åœ¨ catalog ä¸­çš„ä¾èµ–å¯¹æ‰€æœ‰ module å¯è§ï¼Œå½“ä¿®æ”¹ç‰ˆæœ¬å·æ—¶ï¼Œå¯ä»¥ç»Ÿä¸€ç®¡ç†ç»Ÿä¸€ä¿®æ”¹
  - catalog æ”¯æŒå£°æ˜ä¸€ä¸ªä¾èµ– bundlesï¼Œå³ä¸€äº›æ€»æ˜¯ä¸€èµ·ä½¿ç”¨çš„ä¾èµ–çš„ç»„åˆ
  - catalog æ”¯æŒç‰ˆæœ¬å·ä¸ä¾èµ–ååˆ†ç¦»ï¼Œå¯ä»¥åœ¨å¤šä¸ªä¾èµ–é—´å…±äº«ç‰ˆæœ¬å·

### å£°æ˜ Version Catalog

`Version Catalog` å¯ä»¥åœ¨ setting.gradle(.kts) æ–‡ä»¶ä¸­å£°æ˜ã€‚

```groovy
dependencyResolutionManagement {
	versionCatalogs {
		libs {
			alias('retrofit').to('com.squareup.retrofit2:retrofit:2.9.0')
			alias('groovy-core').to('org.codehaus.groovy:groovy:3.0.5')
			alias('groovy-json').to('org.codehaus.groovy:groovy-json:3.0.5')
			alias('groovy-nio').to('org.codehaus.groovy:groovy-nio:3.0.5')
			alias('commons-lang3').to('org.apache.commons', 'commons-lang3').version {
				strictly '[3.8, 4.0['
				prefer '3.9'
			}
		}
	}
}
```

> åˆ«åå¿…é¡»ç”±ä¸€ç³»åˆ—ä»¥ç ´æŠ˜å·ï¼ˆ-ï¼Œæ¨èï¼‰ã€ä¸‹åˆ’çº¿ (_) æˆ–ç‚¹ (.) åˆ†éš”çš„æ ‡è¯†ç¬¦ç»„æˆã€‚ æ ‡è¯†ç¬¦æœ¬èº«å¿…é¡»ç”± ascii å­—ç¬¦ç»„æˆï¼Œæœ€å¥½æ˜¯å°å†™ï¼Œæœ€åæ˜¯æ•°å­—ã€‚
>
> ğŸ¯ æ³¨ï¼šgroovy-core ä¼šè¢«æ˜ å°„æˆ libs.groovy.coreï¼Œå¦‚æœä½ æƒ³é¿å…æ˜ å°„å¯ä»¥ä½¿ç”¨å¤§å°å†™æ¥åŒºåˆ†ï¼Œæ¯”å¦‚ groovyCore ä¼šè¢«å¤„ç†æˆ libs.groovyCore

å¦‚æœå‡ºç°å…·æœ‰ç›¸åŒç‰ˆæœ¬å·çš„ä¾èµ–ï¼Œå¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼›

```groovy
dependencyResolutionManagement {
	versionCatalogs {
        	libs {
			version('groovy', '3.0.5')
			version('compilesdk', '30')
			version('targetsdk', '30')
			alias('groovy-core').to('org.codehaus.groovy', 'groovy').versionRef('groovy')
                        alias('groovy-json').to('org.codehaus.groovy', 'groovy-json').versionRef('groovy')
                        alias('groovy-nio').to('org.codehaus.groovy', 'groovy-nio').versionRef('groovy')
			alias('commons-lang3').to('org.apache.commons', 'commons-lang3').version {
				strictly '[3.8, 4.0['
				prefer '3.9'
			}
		}
	}
}
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨ `build.gradle` æ–‡ä»¶ä¸­æŒ‡å®š `compilesdk` å’Œ `targetsdk`

```groovy
android {
	compileSdk libs.versions.compilesdk.get().toInteger()

	defaultConfig {
        	applicationId "com.simplation.gradlecatalog"
        	minSdk 21
        	targetSdk libs.versions.targetsdk.get().toInteger()
        	versionCode 1
        	versionName "1.0"

        	testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
	}
}
```

### ä¾èµ– `bundles`
ä¸ºäº†æ–¹ä¾¿ç®¡ç†é¡¹ç›®ä¸­ä¸€èµ·ä½¿ç”¨çš„ä¾èµ–é¡¹ï¼Œ`Catalog` å¼•å…¥ `bundles`(ä¾èµ–åŒ…) çš„æ–¹å¼ã€‚ä¾èµ–åŒ…åŸºæœ¬ä¸Šæ˜¯å‡ ä¸ªä¾èµ–é¡¹æ‰“åŒ…çš„åˆ«åã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ä¸€ä¸ªä¾èµ–åŒ…ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢é‚£æ ·å£°æ˜ 3 ä¸ªå•ç‹¬çš„ä¾èµ–é¡¹ï¼š

```groovy
dependencies {
	implementation libs.bundles.groovy
}
```

`groovy` ä¾èµ–åŒ…çš„å£°æ˜å¦‚ä¸‹ï¼š

```groovy
dependencyResolutionManagement {
	versionCatalogs {
        	libs {
			version('groovy', '3.0.5')
			version('checkstyle', '8.37')
			alias('groovy-core').to('org.codehaus.groovy', 'groovy').versionRef('groovy')
			alias('groovy-json').to('org.codehaus.groovy', 'groovy-json').versionRef('groovy')
			alias('groovy-nio').to('org.codehaus.groovy', 'groovy-nio').versionRef('groovy')
			alias('commons-lang3').to('org.apache.commons', 'commons-lang3').version {
				strictly '[3.8, 4.0['
				prefer '3.9'
			}
            
			// ä½¿ç”¨ `bundles`
			bundle('groovy', ['groovy-core', 'groovy-json', 'groovy-nio'])  // â†
		}
	}
}
```

### æ’ä»¶ç‰ˆæœ¬

é™¤äº† `Library` ä¹‹å¤–ï¼Œ`Catalog` è¿˜æ”¯æŒå£°æ˜æ’ä»¶ç‰ˆæœ¬ã€‚ å› ä¸º `library` ç”±å®ƒä»¬çš„ groupã€artifact å’Œ version è¡¨ç¤ºï¼Œä½† `Gradle` æ’ä»¶ä»…ç”±å®ƒä»¬çš„ id å’Œ version æ ‡è¯†ã€‚ å› æ­¤ï¼Œæ’ä»¶éœ€è¦å•ç‹¬å£°æ˜ï¼š

```groovy
dependencyResolutionManagement {
        versionCatalogs {
		libs {
			alias('jmh').toPluginId('me.champeau.jmh').version('0.6.5')
        	}
	}
}
```

ç„¶åå¯ä»¥åœ¨ `plugins` å—ä¸‹é¢ä½¿ç”¨

```groovy
plugins {
	id 'java-library'
        id 'checkstyle'
        // ä½¿ç”¨å£°æ˜çš„æ’ä»¶
        alias(libs.plugins.jmh)
}
```

### ä½¿ç”¨å•ç‹¬æ–‡ä»¶é…ç½® `Catalog`
é™¤äº†åœ¨ `settings.gradle` ä¸­å£°æ˜ Catalog å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æ¥é…ç½® Catalog å¦‚æœåœ¨æ ¹æ„å»ºçš„ `gradle` ç›®å½•ä¸­æ‰¾åˆ°äº† `libs.versions.toml` æ–‡ä»¶,åˆ™å°†ä½¿ç”¨è¯¥æ–‡ä»¶çš„å†…å®¹è‡ªåŠ¨å£°æ˜ä¸€ä¸ª Catalog

`TOML` æ–‡ä»¶ä¸»è¦ç”± 4 ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- [versions] ç”¨äºå£°æ˜å¯ä»¥è¢«ä¾èµ–é¡¹å¼•ç”¨çš„ç‰ˆæœ¬

- [libraries] ç”¨äºå£°æ˜ Library çš„åˆ«å

- [bundles] ç”¨äºå£°æ˜ä¾èµ–åŒ…

- [plugins] ç”¨äºå£°æ˜æ’ä»¶

  ```toml
  # Samples
  [versions]
  groovy = "3.0.5"
  checkstyle = "8.37"
  compilesdk = "30"
  targetsdk = "30"
  
  [libraries]
  retrofit = "com.squareup.retrofit2:retrofit:2.9.0"
  groovy-core = { module = "org.codehaus.groovy:groovy", version.ref = "groovy" }
  groovy-json = { module = "org.codehaus.groovy:groovy-json", version.ref = "groovy" }
  groovy-nio = { module = "org.codehaus.groovy:groovy-nio", version.ref = "groovy" }
  commons-lang3 = { group = "org.apache.commons", name = "commons-lang3", version = { strictly = "[3.8, 4.0[", prefer="3.9" } }
  
  [bundles]
  groovy = ["groovy-core", "groovy-json", "groovy-nio"]
  
  [plugins]
  jmh = { id = "me.champeau.jmh", version = "0.6.5" }
  ```

  å¦‚ä¸Šæ‰€ç¤ºï¼Œä¾èµ–å¯ä»¥å®šä¹‰æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å°† module ä¸ version åˆ†ç¦»å¼€æ¥ å…¶ä¸­ versions å¯ä»¥å®šä¹‰æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥å®šä¹‰æˆä¸€ä¸ªèŒƒå›´ï¼Œè¯¦æƒ…å¯å‚è§ rich-version

  ```toml
  [versions]
  my-lib = { strictly = "[1.0, 2.0[", prefer = "1.2" }
  ```

### å‘å¸ƒæ’ä»¶ä»¥å®ç°é¡¹ç›®é—´å…±äº«

- é€šè¿‡æ–‡ä»¶å…±äº«

  - Catalog æ”¯æŒé€šè¿‡ä» `Toml` æ–‡ä»¶å¼•å…¥ä¾èµ–ï¼Œè¿™å°±è®©æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šæ–‡ä»¶è·¯å¾„æ¥å®ç°å…±äº«ä¾èµ– å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨ `settins.gradle` ä¸­é…ç½®å¦‚ä¸‹ï¼š

    ```groovy
    dependencyResolutionManagement {
    	versionCatalogs {
    		libs {
    			from(files("../gradle/libs.versions.toml"))
    		}
    	}
    }
    ```

  - æ­¤æŠ€æœ¯å¯ç”¨äºå£°æ˜æ¥è‡ªä¸åŒæ–‡ä»¶çš„å¤šä¸ªç›®å½•ï¼š

    ```groovy
    dependencyResolutionManagement {
    	versionCatalogs {
    		// å£°æ˜ä¸€ä¸ª 'testLibs' ç›®å½•, ä» 'test-libs.versions.toml' æ–‡ä»¶ä¸­
    		testLibs {
    			from(files('gradle/test-libs.versions.toml'))
    		}
    	}
    }
    ```

- é€šè¿‡å‘å¸ƒæ’ä»¶å®ç°å…±äº«

  è™½ç„¶ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥ Catalog æ–¹ä¾¿ï¼Œä½†å®ƒå¹¶æ²¡æœ‰è§£å†³åœ¨ç»„ç»‡æˆ–å¤–éƒ¨æ¶ˆè´¹è€…ä¸­å…±äº« Catalog çš„é—®é¢˜ã€‚ æˆ‘ä»¬è¿˜å¯èƒ½é€šè¿‡ Catalog æ’ä»¶æ¥å‘å¸ƒç›®å½•ï¼Œè¿™æ ·ç”¨æˆ·ç›´æ¥å¼•å…¥è¿™ä¸ªæ’ä»¶å³å¯

  `Gradle` æä¾›äº†ä¸€ä¸ª Catalog æ’ä»¶ï¼Œå®ƒæä¾›äº†å£°æ˜ç„¶åå‘å¸ƒ Catalog çš„èƒ½åŠ›ã€‚

  - é¦–å…ˆå¼•å…¥ä¸¤ä¸ªæ’ä»¶

    ```groovy
    plugins {
    	id 'com.android.application'
            id 'kotlin-android'
        
    	// å¼•å…¥æ’ä»¶
    	id 'version-catalog'
    	id 'maven-publish'
    }
    ```

    ç„¶åï¼Œæ­¤æ’ä»¶å°†å…¬å¼€å¯ç”¨äºå£°æ˜ç›®å½•çš„ catalog æ‰©å±•

  - å®šä¹‰ç›®å½•

    ```groovy
    catalog {
    	// åœ¨æ­¤å—ä¸­å£°æ˜åˆ«åã€åŒ…å’Œç‰ˆæœ¬
            versionCatalog {
    		from files("../libs.versions.toml")
    	}
    }
    ```
    é€šè¿‡å®šä¹‰ç›®å½•ï¼Œç„¶åé€šè¿‡ `maven-publish` å‘å¸ƒ

  - å‘å¸ƒç›®å½•

    ```groovy
    publishing {
    	publications {
    		maven(MavenPublication) {
                    groupId = 'com.simplation.catalog'
                    artifactId = 'catalog'
                    version = '1.0.0'
                    from components.versionCatalog
    		}
    	}
    }
    ```

    å®šä¹‰å¥½ `groupId`ï¼Œ`artifactId`ï¼Œ`version`ï¼Œ`from` å°±å¯ä»¥å‘å¸ƒåˆ° `mavenLocal`ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦é…ç½®å‘å¸ƒåˆ°è‡ªå·±çš„ `maven` ä»¥ä¸Šå‘å¸ƒçš„æ‰€æœ‰ä»£ç å¯è§ï¼š[Catalog å‘å¸ƒç›¸å…³ä»£ç ](https://github.com/shenzhen2017/GradleCatalog)
    
  - ä½¿ç”¨
  
    ç”±äºå·²ç»å‘å¸ƒåˆ° `mavenLocal`ï¼Œç›´æ¥å¼•å…¥ `mavenLocal` å°±å¯ä»¥ä½¿ç”¨æ’ä»¶
  
    ```groovy
    # settings.gradle
    dependencyResolutionManagement {
    	//...
    	repositories {
    		mavenLocal()
    		//...
    	}
    }
    
    enableFeaturePreview('VERSION_CATALOGS')
    dependencyResolutionManagement {
    	versionCatalogs {
            	libs {
    			from("com.zj.catalog:catalog:1.0.0")
    			//  ä¹Ÿå¯ä»¥é‡å†™è¦†ç›– catalog ä¸­çš„ groovy ç‰ˆæœ¬
    			version("groovy", "3.0.6")
    		}
    	}
    }
    ```

### å‚è€ƒèµ„æ–™

[Sharing dependency versions between projects (gradle.org)](https://docs.gradle.org/current/userguide/platforms.html)

